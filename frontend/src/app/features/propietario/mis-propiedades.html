<div class="container my-4">
  <!-- Título -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">Panel de propietario</h2>
      <p class="text-muted mb-0">
        Gestiona tus propiedades, reservas, contratos y pagos.
      </p>
    </div>

    <a
      class="btn btn-primary"
      [routerLink]="['/propietario/nueva-propiedad']"
    >
      Publicar nueva propiedad
    </a>
  </div>

  <!-- Tarjetas resumen -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Propiedades</h6>
          <h3 class="card-title mb-0">{{ totalPropiedades }}</h3>
          <small class="text-muted">registradas a tu nombre</small>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Reservas activas</h6>
          <h3 class="card-title mb-0">{{ totalReservasActivas }}</h3>
          <small class="text-muted">entre tus propiedades</small>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Contratos vigentes</h6>
          <h3 class="card-title mb-0">{{ totalContratosVigentes }}</h3>
          <small class="text-muted">en curso actualmente</small>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-3">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Pagos registrados</h6>
          <h3 class="card-title mb-0">{{ totalPagos }}</h3>
          <small class="text-muted">desde tus contratos</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'propiedades'"
        (click)="setTab('propiedades')"
        type="button"
      >
        Propiedades
      </button>
    </li>
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'reservas'"
        (click)="setTab('reservas')"
        type="button"
      >
        Reservas
      </button>
    </li>
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'contratos'"
        (click)="setTab('contratos')"
        type="button"
      >
        Contratos
      </button>
    </li>
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'pagos'"
        (click)="setTab('pagos')"
        type="button"
      >
        Pagos
      </button>
    </li>
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'notificaciones'"
        (click)="setTab('notificaciones')"
        type="button"
      >
        Notificaciones
        <span
          *ngIf="totalNotificacionesNoLeidas > 0"
          class="badge bg-danger ms-1"
        >
          {{ totalNotificacionesNoLeidas }}
        </span>
      </button>
    </li>
  </ul>

  <div *ngIf="errorPropiedades" class="alert alert-danger">
    {{ errorPropiedades }}
  </div>

  <!-- ==========================
       TAB: PROPIEDADES
  =========================== -->
  <div *ngIf="activeTab === 'propiedades'">
    <div *ngIf="cargandoPropiedades" class="text-muted mb-2">
      Cargando propiedades...
    </div>

    <div
      *ngIf="!cargandoPropiedades && propiedades.length === 0"
      class="alert alert-info"
    >
      No tienes propiedades registradas todavía.
    </div>

    <div
      class="table-responsive"
      *ngIf="!cargandoPropiedades && propiedades.length > 0"
    >
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Título</th>
            <th>Ciudad</th>
            <th>Dirección</th>
            <th class="text-end">Precio</th>
            <th>Estado</th>
            <th>Aprobación</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of propiedades">
            <td>
              <div class="d-flex align-items-center">
                <div class="me-2" *ngIf="p.foto_principal">
                  <img
                    [src]="p.foto_principal"
                    style="
                      width: 40px;
                      height: 40px;
                      object-fit: cover;
                      border-radius: 4px;
                    "
                  />
                </div>
                <div>
                  <div class="fw-semibold">{{ p.titulo }}</div>
                  <div class="text-muted small">{{ p.ciudad }}</div>
                </div>
              </div>
            </td>
            <td>{{ p.ciudad }}</td>
            <td>{{ p.direccion }}</td>
            <td class="text-end">
              {{ p.precio | currency: 'CLP':'symbol-narrow' }}
            </td>
            <td>
              <span
                class="badge"
                [ngClass]="{
                  'bg-success': p.estado === 'disponible',
                  'bg-warning': p.estado === 'reservada',
                  'bg-secondary': p.estado === 'arrendada',
                  'bg-danger': p.estado === 'vendida'
                }"
              >
                {{ p.estado | titlecase }}
              </span>
            </td>
            <td>
              <span
                class="badge"
                [ngClass]="{
                  'bg-secondary': p.estado_aprobacion === 'pendiente',
                  'bg-success': p.estado_aprobacion === 'aprobada',
                  'bg-danger': p.estado_aprobacion === 'rechazada',
                  'bg-warning': p.estado_aprobacion === 'pausada'
                }"
              >
                {{ p.estado_aprobacion | titlecase }}
              </span>

              <div
                *ngIf="p.estado_aprobacion === 'rechazada' && p.observacion_admin"
                class="text-danger small mt-1"
              >
                <strong>Observación:</strong> {{ p.observacion_admin }}
              </div>
            </td>

            <td class="text-center">
              <a
                class="btn btn-outline-primary btn-sm me-1"
                [routerLink]="['/propiedad', p.id]"
              >
                Ver detalle
              </a>
              <button
                class="btn btn-outline-secondary btn-sm me-1"
                [routerLink]="['/propietario/editar-propiedad', p.id]"
              >
                Editar
              </button>
              <button
                class="btn btn-outline-dark btn-sm"
                [routerLink]="['/propiedades', p.id, 'historial']"
              >
                Historial
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ==========================
     TAB: RESERVAS
  =========================== -->
  <div *ngIf="activeTab === 'reservas'">
    <div *ngIf="cargandoReservas" class="text-muted mb-2">
      Cargando reservas...
    </div>

    <div
      *ngIf="!cargandoReservas && reservas.length === 0"
      class="alert alert-info"
    >
      Aún no tienes reservas asociadas a tus propiedades.
    </div>

    <div class="table-responsive" *ngIf="!cargandoReservas && reservas.length > 0">
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Propiedad</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th class="text-end">Monto reserva</th>
            <th class="text-center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <ng-container *ngFor="let r of reservas">
            <tr>
              <td>
                <div class="fw-semibold">{{ r.propiedad.titulo }}</div>
                <div class="text-muted small">
                  {{ r.propiedad.ciudad }} • {{ r.propiedad.tipo | titlecase }}
                </div>
              </td>
              <td>
                <div class="fw-semibold">{{ r.interesado.nombre_completo }}</div>
                <div class="text-muted small">{{ r.interesado.rut }}</div>
              </td>
              <td>
                {{ r.fecha | date:'short' }}
                <div class="text-muted small" *ngIf="r.expires_at">
                  Vence: {{ r.expires_at | date:'short' }}
                </div>
              </td>
              <td>
                <span
                  class="badge"
                  [ngClass]="{
                    'bg-success': r.activa && !r.vencida,
                    'bg-warning': r.vencida,
                    'bg-secondary': !r.activa
                  }"
                >
                  {{ r.estado_reserva | titlecase }}
                </span>
              </td>
              <td class="text-end">
                {{ r.monto_reserva | currency:'CLP':'symbol-narrow' }}
              </td>
              <td class="text-center">
                <button
                  class="btn btn-outline-primary btn-sm me-2"
                  (click)="verDetalleReserva(r)"
                >
                  Ver detalle
                </button>


                <button
                  *ngIf="r.activa && !r.vencida"
                  class="btn btn-outline-danger btn-sm"
                  (click)="cancelarReserva(r)"
                >
                  Cancelar
                </button>
              </td>
            </tr>

            <tr *ngIf="selectedReserva && selectedReserva.id === r.id">
              <td colspan="6">
                <div class="card shadow-sm mt-3">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                      <h5 class="card-title mb-3">
                        Detalle de reserva #{{ selectedReserva.id }}
                      </h5>
                      <button
                        class="btn btn-sm btn-outline-secondary"
                        (click)="cerrarDetalleReserva()"
                      >
                        Cerrar
                      </button>
                    </div>

                    <div class="row">
                      <div class="col-md-4 mb-3">
                        <h6>Propiedad</h6>
                        <p class="mb-1 fw-semibold">
                          {{ selectedReserva.propiedad.titulo }}
                        </p>
                        <p class="text-muted mb-0">
                          {{ selectedReserva.propiedad.ciudad }} •
                          {{ selectedReserva.propiedad.tipo | titlecase }}
                        </p>
                      </div>

                      <div class="col-md-4 mb-3">
                        <h6>Cliente interesado</h6>
                        <p class="mb-1 fw-semibold">
                          {{ selectedReserva.interesado.nombre_completo }}
                        </p>
                        <p class="mb-0 text-muted">
                          RUT: {{ selectedReserva.interesado.rut }}<br />
                          Email: {{ selectedReserva.interesado.email }}<br />
                          Teléfono: {{ selectedReserva.interesado.telefono }}
                        </p>
                      </div>

                      <div class="col-md-4 mb-3">
                        <h6>Fechas</h6>
                        <p class="mb-1">
                          Creada:
                          {{ selectedReserva.fecha | date:'short' }}
                        </p>
                        <p class="mb-1" *ngIf="selectedReserva.expires_at">
                          Vence:
                          {{ selectedReserva.expires_at | date:'short' }}
                        </p>

                        <h6 class="mt-2">Estado</h6>
                        <span
                          class="badge"
                          [ngClass]="{
                            'bg-success': selectedReserva.activa && !selectedReserva.vencida,
                            'bg-warning': selectedReserva.vencida,
                            'bg-secondary': !selectedReserva.activa
                          }"
                        >
                          {{ selectedReserva.estado_reserva | titlecase }}
                        </span>
                      </div>
                    </div>

                    <div class="row mt-3">
                      <div class="col-md-6">
                        <h6>Monto reserva</h6>
                        <p class="fw-semibold">
                          {{ selectedReserva.monto_reserva | currency:'CLP':'symbol-narrow' }}
                        </p>
                      </div>
                    </div>

                    <div class="mt-3" *ngIf="selectedReserva.notas">
                      <h6>Notas</h6>
                      <p class="mb-0">{{ selectedReserva.notas }}</p>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </ng-container>
        </tbody>
      </table>
    </div>
  </div>


  <!-- ==========================
       TAB: CONTRATOS
  =========================== -->
  <div *ngIf="activeTab === 'contratos'">
    <div *ngIf="cargandoContratos" class="text-muted mb-2">
      Cargando contratos...
    </div>

    <div
      *ngIf="!cargandoContratos && contratos.length === 0"
      class="alert alert-info"
    >
      No tienes contratos vigentes ni históricos asociados a tus propiedades.
    </div>

    <div
      class="table-responsive"
      *ngIf="!cargandoContratos && contratos.length > 0"
    >
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Propiedad</th>
            <th>Cliente</th>
            <th>Tipo</th>
            <th>Fecha firma</th>
            <th class="text-end">Precio pactado</th>
            <th class="text-end">Pagado</th>
            <th class="text-end">Saldo</th>
            <th>Vigente</th>
            <th class="text-center">Contrato</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of contratos">
            <td>
              <div class="fw-semibold">{{ c.propiedad.titulo }}</div>
              <div class="text-muted small">
                {{ c.propiedad.ciudad }} • {{ c.propiedad.tipo | titlecase }}
              </div>
            </td>
            <td>
              <div class="fw-semibold">
                {{ c.comprador_arrendatario.nombre_completo }}
              </div>
              <div class="text-muted small">
                {{ c.comprador_arrendatario.rut }}
              </div>
            </td>
            <td>{{ c.tipo_display }}</td>
            <td>{{ c.fecha_firma | date }}</td>
            <td class="text-end">
              {{ c.precio_pactado | currency: 'CLP':'symbol-narrow' }}
            </td>
            <td class="text-end">
              {{ c.total_pagos | currency: 'CLP':'symbol-narrow' }}
            </td>
            <td class="text-end">
              {{ c.saldo | currency: 'CLP':'symbol-narrow' }}
            </td>
            <td>
              <span
                class="badge"
                [ngClass]="c.vigente ? 'bg-success' : 'bg-secondary'"
              >
                {{ c.vigente ? 'Vigente' : 'Cerrado' }}
            
              </span>
            </td>
            <td class="text-center">
              <a
                *ngIf="c.archivo_pdf_url; else sinContrato"
                [href]="c.archivo_pdf_url"
                target="_blank"
                class="btn btn-outline-primary btn-sm"
              >
                Descargar PDF
              </a>
              <ng-template #sinContrato>
                <span class="text-muted small">No adjunto</span>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ==========================
       TAB: PAGOS
  =========================== -->
  <div *ngIf="activeTab === 'pagos'">
    <div *ngIf="cargandoPagos" class="text-muted mb-2">
      Cargando pagos...
    </div>

    <div
      *ngIf="!cargandoPagos && pagos.length === 0"
      class="alert alert-info"
    >
      Todavía no se han registrado pagos asociados a tus contratos.
    </div>

    <div
      class="table-responsive"
      *ngIf="!cargandoPagos && pagos.length > 0"
    >
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Propiedad</th>
            <th>Cliente</th>
            <th>Fecha</th>
            <th>Medio</th>
            <th class="text-end">Monto</th>
            <th class="text-center">Comprobante</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of pagos">
            <td>
              <div class="fw-semibold">
                {{ p.propiedad?.titulo || 'Propiedad' }}
              </div>
              <div class="text-muted small" *ngIf="p.propiedad">
                {{ p.propiedad.ciudad }} • {{ p.propiedad.tipo | titlecase }}
              </div>
            </td>
            <td>
              <div class="fw-semibold">
                {{ p.cliente?.nombre || 'Cliente' }}
              </div>
              <div class="text-muted small" *ngIf="p.cliente">
                {{ p.cliente.rut }}
              </div>
            </td>
            <td>{{ p.fecha | date }}</td>
            <td>{{ p.medio | titlecase }}</td>
            <td class="text-end">
              {{ p.monto | currency: 'CLP':'symbol-narrow' }}
            </td>
            <td class="text-center">
              <a
                *ngIf="p.comprobante_url; else sinComprobante"
                [href]="p.comprobante_url"
                target="_blank"
                class="btn btn-outline-secondary btn-sm"
              >
                Ver boleta
              </a>
              <ng-template #sinComprobante>
                <span class="text-muted small">No adjunto</span>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

  <!-- ==========================
       TAB: NOTIFICACIONES
  =========================== -->
  <div *ngIf="activeTab === 'notificaciones'">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h5 class="mb-0">Notificaciones</h5>
      <button
        class="btn btn-sm btn-outline-secondary"
        (click)="marcarTodasNotificaciones()"
        [disabled]="notificaciones.length === 0 || totalNotificacionesNoLeidas === 0"
      >
        Marcar todas como leídas
      </button>
    </div>

    <div *ngIf="cargandoNotificaciones" class="text-muted mb-2">
      Cargando notificaciones...
    </div>

    <div *ngIf="errorNotificaciones" class="alert alert-danger">
      {{ errorNotificaciones }}
    </div>

    <div
      *ngIf="!cargandoNotificaciones && !errorNotificaciones && notificaciones.length === 0"
      class="alert alert-info"
    >
      No tienes notificaciones por el momento.
    </div>

    <div
      class="list-group"
      *ngIf="!cargandoNotificaciones && !errorNotificaciones && notificaciones.length > 0"
    >
      <div
        *ngFor="let n of notificaciones"
        class="list-group-item list-group-item-action d-flex justify-content-between align-items-start"
        [ngClass]="{ 'bg-light': !n.leida }"
      >
        <div class="me-3">
          <div class="d-flex align-items-center mb-1">
            <span
              class="badge me-2"
              [ngClass]="{
                'bg-primary': n.tipo === 'RESERVA',
                'bg-success': n.tipo === 'PAGO',
                'bg-info': n.tipo === 'VISITA',
                'bg-secondary': n.tipo === 'SISTEMA'
              }"
            >
              {{ n.tipo }}
            </span>
            <strong>{{ n.titulo }}</strong>
          </div>
          <div class="small text-muted mb-1">
            {{ n.created_at | date:'short' }}
          </div>
          <div>
            {{ n.mensaje }}
          </div>
        </div>

        <div class="text-end">
          <button
            class="btn btn-sm"
            [ngClass]="n.leida ? 'btn-outline-secondary' : 'btn-outline-primary'"
            (click)="marcarNotificacionLeida(n)"
            [disabled]="n.leida"
          >
            {{ n.leida ? 'Leída' : 'Marcar como leída' }}
          </button>
        </div>
      </div>
    </div>
  </div>
