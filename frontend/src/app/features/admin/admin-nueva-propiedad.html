<div class="container my-4">
  <h2 class="mb-3">Nueva propiedad (administrador)</h2>
  <p class="text-muted mb-3">
    Desde aquí puedes crear una nueva propiedad y asociarla a un propietario
    existente o crear uno nuevo.
  </p>

  <!-- Errores de carga de propietarios -->
  <div *ngIf="errorPropietarios" class="alert alert-danger">
    {{ errorPropietarios }}
  </div>

  <!-- Formulario principal -->
  <form
    [formGroup]="formProp"
    (ngSubmit)="guardarPropiedad()"
    class="card shadow-sm mb-4"
  >
    <div class="card-body">
      <h5 class="card-title mb-3">Datos de la propiedad</h5>

      <!-- Propietario -->
      <div class="mb-3">
        <label class="form-label">Propietario</label>

        <select
          class="form-select"
          formControlName="propietario_id"
          [disabled]="cargandoPropietarios || propietarios.length === 0"
        >
          <option [ngValue]="null" disabled>
            {{
              cargandoPropietarios
                ? 'Cargando propietarios...'
                : propietarios.length === 0
                ? 'No hay propietarios registrados'
                : 'Selecciona un propietario'
            }}
          </option>
          <option
            *ngFor="let p of propietarios"
            [ngValue]="p.id"
          >
            {{ p.primer_nombre }} {{ p.primer_apellido }} - {{ p.rut }}
          </option>
        </select>

        <div
          *ngIf="campoInvalido(formProp, 'propietario_id')"
          class="text-danger small mt-1"
        >
          Debes seleccionar un propietario.
        </div>

        <button
          type="button"
          class="btn btn-link btn-sm mt-2 p-0"
          (click)="toggleNuevoPropietario()"
        >
          {{
            mostrarFormNuevoPropietario
              ? 'Cancelar nuevo propietario'
              : '+ Añadir nuevo propietario'
          }}
        </button>
      </div>

      <!-- Nuevo propietario inline -->
      <div
        *ngIf="mostrarFormNuevoPropietario"
        class="border rounded p-3 mb-3 bg-light"
        [formGroup]="formNuevoProp"
      >
        <h6 class="mb-2">Nuevo propietario</h6>

        <div class="row g-2">
          <div class="col-md-6 mb-2">
            <label class="form-label">Primer nombre</label>
            <input
              type="text"
              class="form-control"
              formControlName="primer_nombre"
            />
            <div
              *ngIf="campoInvalido(formNuevoProp, 'primer_nombre')"
              class="text-danger small"
            >
              Obligatorio.
            </div>
          </div>

          <div class="col-md-6 mb-2">
            <label class="form-label">Segundo nombre</label>
            <input
              type="text"
              class="form-control"
              formControlName="segundo_nombre"
            />
          </div>

          <div class="col-md-6 mb-2">
            <label class="form-label">Primer apellido</label>
            <input
              type="text"
              class="form-control"
              formControlName="primer_apellido"
            />
            <div
              *ngIf="campoInvalido(formNuevoProp, 'primer_apellido')"
              class="text-danger small"
            >
              Obligatorio.
            </div>
          </div>

          <div class="col-md-6 mb-2">
            <label class="form-label">Segundo apellido</label>
            <input
              type="text"
              class="form-control"
              formControlName="segundo_apellido"
            />
          </div>

          <div class="col-md-4 mb-2">
            <label class="form-label">RUT</label>
            <input
              type="text"
              class="form-control"
              formControlName="rut"
            />
            <div
              *ngIf="campoInvalido(formNuevoProp, 'rut')"
              class="text-danger small"
            >
              Obligatorio.
            </div>
          </div>

          <div class="col-md-4 mb-2">
            <label class="form-label">Teléfono</label>
            <input
              type="text"
              class="form-control"
              formControlName="telefono"
            />
            <div
              *ngIf="campoInvalido(formNuevoProp, 'telefono')"
              class="text-danger small"
            >
              Obligatorio.
            </div>
          </div>

          <div class="col-md-4 mb-2">
            <label class="form-label">Email</label>
            <input
              type="email"
              class="form-control"
              formControlName="email"
            />
            <div
              *ngIf="campoInvalido(formNuevoProp, 'email')"
              class="text-danger small"
            >
              Ingresa un email válido.
            </div>
          </div>
        </div>

        <div *ngIf="errorNuevoProp" class="alert alert-danger mt-2">
          {{ errorNuevoProp }}
        </div>

        <button
          type="button"
          class="btn btn-sm btn-primary mt-2"
          (click)="crearNuevoPropietario()"
          [disabled]="creandoPropietario"
        >
          {{ creandoPropietario ? 'Guardando...' : 'Guardar propietario' }}
        </button>
      </div>

      <!-- Título / ciudad -->
      <div class="row g-3">
        <div class="col-md-6">
          <label class="form-label">Título</label>
          <input
            type="text"
            class="form-control"
            formControlName="titulo"
          />
          <div
            *ngIf="campoInvalido(formProp, 'titulo')"
            class="text-danger small"
          >
            El título es obligatorio.
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Ciudad</label>
          <input
            type="text"
            class="form-control"
            formControlName="ciudad"
          />
          <div
            *ngIf="campoInvalido(formProp, 'ciudad')"
            class="text-danger small"
          >
            La ciudad es obligatoria.
          </div>
        </div>
      </div>

      <!-- Dirección -->
      <div class="mt-3">
        <label class="form-label">Dirección</label>
        <input
          type="text"
          class="form-control"
          formControlName="direccion"
        />
        <div
          *ngIf="campoInvalido(formProp, 'direccion')"
          class="text-danger small"
        >
          La dirección es obligatoria.
        </div>
      </div>

      <!-- Tipo y características -->
      <div class="row g-3 mt-3">
        <div class="col-md-4">
          <label class="form-label">Tipo de propiedad</label>
          <select class="form-select" formControlName="tipo">
            <option *ngFor="let t of tipos" [value]="t.value">
              {{ t.label }}
            </option>
          </select>
        </div>

        <div class="col-md-2">
          <label class="form-label">Dormitorios</label>
          <input
            type="number"
            class="form-control"
            formControlName="dormitorios"
            min="0"
          />
        </div>

        <div class="col-md-2">
          <label class="form-label">Baños</label>
          <input
            type="number"
            class="form-control"
            formControlName="baos"
            min="0"
          />
        </div>

        <div class="col-md-2">
          <label class="form-label">m²</label>
          <input
            type="number"
            class="form-control"
            formControlName="metros2"
            min="0"
          />
        </div>

        <div class="col-md-2">
          <label class="form-label">Precio (CLP)</label>
          <input
            type="number"
            class="form-control"
            formControlName="precio"
            min="0"
          />
          <div
            *ngIf="campoInvalido(formProp, 'precio')"
            class="text-danger small"
          >
            El precio es obligatorio.
          </div>
        </div>
      </div>

      <!-- Descripción -->
      <div class="mt-3">
        <label class="form-label">Descripción</label>
        <textarea
          rows="4"
          class="form-control"
          formControlName="descripcion"
          placeholder="Descripción de la propiedad, condiciones, equipamiento, etc."
        ></textarea>
      </div>

      <div *ngIf="errorForm" class="alert alert-danger mt-3">
        {{ errorForm }}
      </div>
      <div *ngIf="exito" class="alert alert-success mt-3">
        Propiedad creada correctamente.
      </div>

      <div class="mt-3 d-flex justify-content-end">
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="guardando || cargandoPropietarios"
        >
          {{ guardando ? 'Guardando...' : 'Guardar propiedad' }}
        </button>
      </div>
    </div>
  </form>

  <small class="text-muted">
    La propiedad se crea directamente como <strong>aprobada</strong> y
    disponible en el catálogo. Si quieres manejar flujo de aprobación, puedes
    cambiar el campo <code>estado_aprobacion</code> a "pendiente" desde este
    mismo formulario.
  </small>
</div>
