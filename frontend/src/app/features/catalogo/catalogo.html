<div class="container py-4">
  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2 class="mb-1">Catalogo de propiedades</h2>
      <small class="text-muted">Encuentra tu propiedad ideal</small>
    </div>
    <button
      class="btn btn-outline-secondary btn-sm"
      (click)="toggleFiltros()"
    >
      {{ mostrarFiltros ? 'Ocultar filtros' : 'Mostrar filtros' }}
    </button>
  </div>

  <!-- Filtros -->
  <div class="card shadow-sm mb-4" *ngIf="mostrarFiltros">
    <div class="card-body">
      <div class="row g-3">
        <!-- Busqueda -->
        <div class="col-12 col-md-4">
          <label class="form-label small text-muted">Buscar</label>
          <input
            type="text"
            class="form-control form-control-sm"
            placeholder="Titulo, descripcion, ciudad..."
            [(ngModel)]="filtros.search"
            (keyup.enter)="aplicarFiltros()"
          />
        </div>

        <!-- Ciudad -->
        <div class="col-6 col-md-2">
          <label class="form-label small text-muted">Ciudad</label>
          <select class="form-select form-select-sm" [(ngModel)]="filtros.ciudad">
            <option value="">Todas</option>
            <option *ngFor="let c of ciudades" [value]="c">{{ c }}</option>
          </select>
        </div>

        <!-- Tipo -->
        <div class="col-6 col-md-2">
          <label class="form-label small text-muted">Tipo</label>
          <select class="form-select form-select-sm" [(ngModel)]="filtros.tipo">
            <option value="">Todos</option>
            <option *ngFor="let t of tipos" [value]="t">{{ t | titlecase }}</option>
          </select>
        </div>

        <!-- Estado -->
        <div class="col-6 col-md-2">
          <label class="form-label small text-muted">Estado</label>
          <select class="form-select form-select-sm" [(ngModel)]="filtros.estado">
            <option value="">Todos</option>
            <option *ngFor="let e of estados" [value]="e">{{ e | titlecase }}</option>
          </select>
        </div>

        <!-- Dormitorios -->
        <div class="col-6 col-md-2">
          <label class="form-label small text-muted">Dormitorios min.</label>
          <select class="form-select form-select-sm" [(ngModel)]="filtros.dormitorios_min">
            <option [ngValue]="null">Cualquiera</option>
            <option [ngValue]="1">1+</option>
            <option [ngValue]="2">2+</option>
            <option [ngValue]="3">3+</option>
            <option [ngValue]="4">4+</option>
            <option [ngValue]="5">5+</option>
          </select>
        </div>

        <!-- Precio min -->
        <div class="col-6 col-md-2">
          <label class="form-label small text-muted">Precio min.</label>
          <input
            type="number"
            class="form-control form-control-sm"
            placeholder="Ej: 50000000"
            [(ngModel)]="filtros.precio_min"
          />
        </div>

        <!-- Precio max -->
        <div class="col-6 col-md-2">
          <label class="form-label small text-muted">Precio max.</label>
          <input
            type="number"
            class="form-control form-control-sm"
            placeholder="Ej: 200000000"
            [(ngModel)]="filtros.precio_max"
          />
        </div>

        <!-- Botones -->
        <div class="col-12 col-md-4 d-flex align-items-end gap-2">
          <button
            class="btn btn-primary btn-sm flex-grow-1"
            (click)="aplicarFiltros()"
            [disabled]="cargando"
          >
            <span *ngIf="cargando" class="spinner-border spinner-border-sm me-1"></span>
            Buscar
          </button>
          <button
            class="btn btn-outline-secondary btn-sm"
            (click)="limpiarFiltros()"
            [disabled]="cargando"
          >
            Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Mensajes de estado -->
  <div *ngIf="cargando" class="alert alert-info py-2">
    <span class="spinner-border spinner-border-sm me-2"></span>
    Cargando propiedades...
  </div>
  <div *ngIf="error" class="alert alert-danger py-2">{{ error }}</div>

  <!-- Contador de resultados -->
  <div *ngIf="!cargando && !error" class="mb-3">
    <small class="text-muted">
      {{ propiedades.length }} propiedad{{ propiedades.length !== 1 ? 'es' : '' }} encontrada{{ propiedades.length !== 1 ? 's' : '' }}
    </small>
  </div>

  <!-- Lista de propiedades -->
  <div class="row g-3">
    <div class="col-md-4 col-lg-3" *ngFor="let p of propiedades">
      <div class="card h-100 shadow-sm">
        <!-- Imagen principal -->
        <ng-container *ngIf="p.fotos && p.fotos.length > 0; else sinFoto">
          <img
            [src]="p.fotos[0].url"
            class="card-img-top"
            style="height: 180px; object-fit: cover;"
            [alt]="p.titulo"
          />
        </ng-container>
        <ng-template #sinFoto>
          <div
            class="d-flex align-items-center justify-content-center bg-secondary text-white"
            style="height: 180px;"
          >
            <span>Sin foto</span>
          </div>
        </ng-template>

        <!-- Badge de estado -->
        <div class="position-absolute top-0 end-0 m-2">
          <span
            class="badge"
            [ngClass]="{
              'bg-success': p.estado === 'disponible',
              'bg-warning text-dark': p.estado === 'reservada',
              'bg-secondary': p.estado === 'arrendada' || p.estado === 'vendida'
            }"
          >
            {{ p.estado | titlecase }}
          </span>
        </div>

        <div class="card-body d-flex flex-column">
          <h6 class="card-title mb-1">{{ p.titulo }}</h6>
          <p class="card-text small text-muted mb-1">
            {{ p.ciudad }} · {{ p.tipo | titlecase }}
          </p>
          <p class="card-text small mb-2">
            {{ p.dormitorios }} dorm. · {{ p.baos }} banos · {{ p.metros2 }} m2
          </p>
          <p class="card-text fw-bold text-success mb-3">
            {{ p.precio | currency:'CLP':'symbol':'1.0-0' }}
          </p>
          <div class="mt-auto">
            <a
              [routerLink]="['/propiedad', p.id]"
              class="btn btn-primary btn-sm w-100"
            >
              Ver detalle
            </a>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="!cargando && !error && propiedades.length === 0" class="col-12">
      <div class="alert alert-warning text-center">
        <p class="mb-2">No se encontraron propiedades con los filtros seleccionados.</p>
        <button class="btn btn-sm btn-outline-warning" (click)="limpiarFiltros()">
          Limpiar filtros
        </button>
      </div>
    </div>
  </div>
</div>
