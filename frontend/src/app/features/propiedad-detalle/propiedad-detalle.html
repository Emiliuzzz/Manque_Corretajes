<div class="container my-4">
  <!-- Estado de carga / error -->
  <div *ngIf="cargando" class="alert alert-info">Cargando propiedad...</div>
  <div *ngIf="!cargando && error" class="alert alert-danger">{{ error }}</div>

  <!-- Usamos alias 'p' para la propiedad -->
  <ng-container *ngIf="!cargando && prop as p">
    <div class="row">
      <div class="col-md-6 mb-3">
        <!-- Foto principal -->
        <ng-container
          *ngIf="p.fotos && p.fotos.length > 0 && fotoSeleccionada?.url; else sinFoto"
        >
          <img
            [src]="fotoSeleccionada?.url!"
            class="img-fluid rounded main-photo"
            alt="Foto principal de la propiedad"
            (click)="abrirLightbox(fotoSeleccionada)"
          />
        </ng-container>

        <ng-template #sinFoto>
          <div
            class="d-flex align-items-center justify-content-center bg-secondary text-white rounded main-photo-placeholder"
          >
            Sin foto disponible
          </div>
        </ng-template>

        <!-- Thumbnails -->
        <div
          class="d-flex flex-wrap gap-2 mt-2"
          *ngIf="p.fotos && p.fotos.length > 1"
        >
          <img
            *ngFor="let f of p.fotos"
            [src]="f.url"
            class="rounded thumb-photo"
            [class.thumb-active]="f.id === fotoSeleccionada?.id"
            alt="Miniatura propiedad"
            (click)="seleccionarFoto(f)"
          />
        </div>
      </div>

      <!-- Columna derecha: información y acción -->
      <div class="col-md-6">
        <h2 class="mb-1">{{ p.titulo }}</h2>
        <p class="text-muted mb-1">
          {{ p.ciudad }} · {{ p.direccion }}
        </p>
        <p class="text-muted">
          Tipo: <strong>{{ p.tipo | titlecase }}</strong>
        </p>

        <p class="h4 text-success mb-3">
          {{ p.precio | currency: 'CLP':'symbol-narrow' }}
        </p>

        <p class="mb-1">
          <strong>Dormitorios:</strong> {{ p.dormitorios }} ·
          <strong>Baños:</strong> {{ p.baos }} ·
          <strong>m²:</strong> {{ p.metros2 }}
        </p>

        <p class="mb-3">
          <strong>Estado:</strong>
          <span class="badge bg-primary">{{ p.estado | titlecase }}</span>
        </p>

        <p class="mb-3" *ngIf="p.descripcion">
          {{ p.descripcion }}
        </p>

        <!-- Botón para solicitar reserva -->
        <div class="mt-3">
          <button class="btn btn-primary me-2" (click)="abrirReserva()">
            Solicitar reserva
          </button>
          <small class="text-muted d-block mt-1">
            La solicitud será revisada por la corredora y el propietario.
          </small>
        </div>

        <!-- Mensajes de error/éxito de reserva -->
        <div *ngIf="reservaError" class="alert alert-danger mt-3">
          {{ reservaError }}
        </div>
        <div *ngIf="reservaExito" class="alert alert-success mt-3">
          {{ reservaExito }}
        </div>

        <!-- Formulario de reserva -->
        <div *ngIf="mostrarReserva" class="card mt-3 shadow-sm">
          <div class="card-body">
            <h5 class="card-title mb-3">Datos de la reserva</h5>

            <div class="mb-3">
              <label class="form-label">Monto de reserva (CLP)</label>
              <input
                type="number"
                class="form-control"
                [(ngModel)]="reservaMonto"
                name="montoReserva"
                min="1"
              />
            </div>

            <div class="mb-3">
              <label class="form-label">
                Comentarios para la corredora / propietario
              </label>
              <textarea
                class="form-control"
                rows="3"
                [(ngModel)]="reservaNotas"
                name="notasReserva"
                placeholder="Ej: Estoy interesado en arrendar a partir de enero..."
              ></textarea>
            </div>

            <div class="d-flex justify-content-end">
              <button
                type="button"
                class="btn btn-outline-secondary me-2"
                (click)="mostrarReserva = false"
                [disabled]="creandoReserva"
              >
                Cancelar
              </button>
              <button
                type="button"
                class="btn btn-primary"
                (click)="enviarReserva()"
                [disabled]="creandoReserva"
              >
                {{ creandoReserva ? 'Enviando...' : 'Confirmar reserva' }}
              </button>
            </div>
          </div>
        </div>

        <!-- Mensaje para otros roles -->
        <div *ngIf="estaLogueado && !esCliente" class="alert alert-info mt-3">
          Estás autenticado con el rol
          <strong>{{ auth.getPayload()?.rol }}</strong>. Solo los usuarios con
          rol <strong>CLIENTE</strong> pueden solicitar reservas.
        </div>
      </div>
    </div>

    <!-- Lightbox -->
    <div
      class="lightbox-backdrop"
      *ngIf="lightboxVisible"
      (click)="cerrarLightbox()"
    >
      <div class="lightbox-content" (click)="$event.stopPropagation()">
        <button
          type="button"
          class="btn btn-sm btn-light position-absolute top-0 end-0 m-2"
          (click)="cerrarLightbox()"
        >
          ×
        </button>
        <img
          *ngIf="lightboxFoto?.url"
          [src]="lightboxFoto?.url!"
          alt="Foto grande"
          class="img-fluid rounded"
        />
      </div>
    </div>
  </ng-container>
</div>
