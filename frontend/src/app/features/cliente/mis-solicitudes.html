<div class="container my-4">
  <!-- T√≠tulo -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">Mis solicitudes</h2>
      <p class="text-muted mb-0">
        Revisa el estado de tus reservas, contratos y pagos.
      </p>
    </div>

    <!-- üîπ Bot√≥n para crear nueva solicitud -->
    <div>
      <a
        class="btn btn-outline-primary"
        routerLink="/perfil"
      >
        Nueva solicitud
      </a>
    </div>
  </div>


  <!-- Tarjetas resumen -->
  <div class="row g-3 mb-4">
    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Reservas activas</h6>
          <h3 class="card-title mb-0">{{ totalReservasActivas }}</h3>
          <small class="text-muted">pendientes o en revisi√≥n</small>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Contratos vigentes</h6>
          <h3 class="card-title mb-0">{{ totalContratosVigentes }}</h3>
          <small class="text-muted">arriendos o compras en curso</small>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Pagos registrados</h6>
          <h3 class="card-title mb-0">{{ totalPagos }}</h3>
          <small class="text-muted">pagos asociados a tus contratos</small>
        </div>
      </div>
    </div>

    <div class="col-12 col-md-4">
      <div class="card shadow-sm h-100">
        <div class="card-body">
          <h6 class="card-subtitle mb-2 text-muted">Solicitudes de b√∫squeda</h6>
          <h3 class="card-title mb-0">{{ totalSolicitudes }}</h3>
          <small class="text-muted">enviadas al sistema</small>
        </div>
      </div>
    </div>
  </div>



  <!-- Tabs -->
  <ul class="nav nav-tabs mb-3">
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'reservas'"
        (click)="setTab('reservas')"
        type="button"
      >
        Reservas
      </button>
    </li>
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'contratos'"
        (click)="setTab('contratos')"
        type="button"
      >
        Contratos
      </button>
    </li>
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'pagos'"
        (click)="setTab('pagos')"
        type="button"
      >
        Pagos
      </button>
    </li>
    <li class="nav-item">
      <button
        class="nav-link"
        [class.active]="activeTab === 'solicitudes'"
        (click)="setTab('solicitudes')"
      >
        Solicitudes
      </button>
    </li>
  </ul>

  


  <!-- ============ TAB RESERVAS ============ -->
  <div *ngIf="activeTab === 'reservas'">
    <div *ngIf="cargandoReservas" class="text-muted mb-2">
      Cargando reservas...
    </div>

    <div
      *ngIf="!cargandoReservas && reservas.length === 0 && !errorReservas"
      class="alert alert-info"
    >
      A√∫n no tienes reservas registradas en el sistema.
    </div>

    <div *ngIf="errorReservas" class="alert alert-danger">
      {{ errorReservas }}
    </div>

    <div
      class="table-responsive"
      *ngIf="!cargandoReservas && reservas.length > 0"
    >
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Propiedad</th>
            <th>Fecha</th>
            <th>Estado</th>
            <th class="text-end">Monto reserva</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let r of reservas">
            <td>
              <div class="fw-semibold">{{ r.propiedad.titulo }}</div>
              <div class="text-muted small">
                {{ r.propiedad.ciudad }} ‚Ä¢ {{ r.propiedad.tipo | titlecase }}
              </div>
            </td>
            <td>
              {{ r.fecha | date: 'short' }}
              <div class="text-muted small" *ngIf="r.expires_at">
                Vence: {{ r.expires_at | date: 'short' }}
              </div>
            </td>
            <td>
              <span
                class="badge"
                [ngClass]="{
                  'bg-success': r.activa && !r.vencida,
                  'bg-warning': r.vencida,
                  'bg-secondary': !r.activa
                }"
              >
                {{ r.estado_reserva | titlecase }}
              </span>
            </td>
            <td class="text-end">
              {{ r.monto_reserva | currency: 'CLP':'symbol-narrow' }}
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ============ TAB CONTRATOS ============ -->
  <div *ngIf="activeTab === 'contratos'">
    <div *ngIf="cargandoContratos" class="text-muted mb-2">
      Cargando contratos...
    </div>

    <div
      *ngIf="!cargandoContratos && contratos.length === 0 && !errorContratos"
      class="alert alert-info"
    >
      No tienes contratos vigentes ni hist√≥ricos registrados.
    </div>

    <div *ngIf="errorContratos" class="alert alert-danger">
      {{ errorContratos }}
    </div>

    <div
      class="table-responsive"
      *ngIf="!cargandoContratos && contratos.length > 0"
    >
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Propiedad</th>
            <th>Tipo</th>
            <th>Fecha firma</th>
            <th class="text-end">Precio pactado</th>
            <th class="text-end">Pagado</th>
            <th class="text-end">Saldo</th>
            <th>Contrato</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let c of contratos">
            <td>
              <div class="fw-semibold">{{ c.propiedad.titulo }}</div>
              <div class="text-muted small">
                {{ c.propiedad.ciudad }} ‚Ä¢ {{ c.propiedad.tipo | titlecase }}
              </div>
            </td>
            <td>{{ c.tipo_display }}</td>
            <td>{{ c.fecha_firma | date }}</td>
            <td class="text-end">
              {{ c.precio_pactado | currency: 'CLP':'symbol-narrow' }}
            </td>
            <td class="text-end">
              {{ c.total_pagos | currency: 'CLP':'symbol-narrow' }}
            </td>
            <td class="text-end">
              {{ c.saldo | currency: 'CLP':'symbol-narrow' }}
            </td>
            <td>
              <ng-container *ngIf="c.archivo_pdf_url; else sinContrato">
                <a
                  [href]="c.archivo_pdf_url"
                  target="_blank"
                  rel="noopener"
                  class="btn btn-sm btn-outline-primary"
                >
                  Ver PDF
                </a>
              </ng-container>
              <ng-template #sinContrato>
                <span class="text-muted small">Sin archivo adjunto</span>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ============ TAB PAGOS ============ -->
  <div *ngIf="activeTab === 'pagos'">
    <div *ngIf="cargandoPagos" class="text-muted mb-2">
      Cargando pagos...
    </div>

    <div
      *ngIf="!cargandoPagos && pagos.length === 0 && !errorPagos"
      class="alert alert-info"
    >
      Todav√≠a no se han registrado pagos asociados a tus contratos.
    </div>

    <div *ngIf="errorPagos" class="alert alert-danger">
      {{ errorPagos }}
    </div>

    <div
      class="table-responsive"
      *ngIf="!cargandoPagos && pagos.length > 0"
    >
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Propiedad</th>
            <th>Fecha</th>
            <th>Medio</th>
            <th class="text-end">Monto</th>
            <th>Comprobante</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let p of pagos">
            <td>
              <div class="fw-semibold">
                {{ p.propiedad?.titulo || 'Propiedad' }}
              </div>
              <div class="text-muted small" *ngIf="p.propiedad">
                {{ p.propiedad.ciudad }} ‚Ä¢ {{ p.propiedad.tipo | titlecase }}
              </div>
            </td>
            <td>{{ p.fecha | date }}</td>
            <td>{{ p.medio | titlecase }}</td>
            <td class="text-end">
              {{ p.monto | currency: 'CLP':'symbol-narrow' }}
            </td>
            <td>
              <ng-container *ngIf="p.comprobante_url; else sinComprobante">
                <a
                  [href]="p.comprobante_url"
                  target="_blank"
                  rel="noopener"
                  class="btn btn-sm btn-outline-secondary"
                >
                  Ver comprobante
                </a>
              </ng-container>
              <ng-template #sinComprobante>
                <span class="text-muted small">Sin comprobante</span>
              </ng-template>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- TAB SOLICITUDES -->
  <div class="mt-3" *ngIf="activeTab === 'solicitudes'">
    <div *ngIf="cargandoSolicitudes" class="alert alert-info">
      Cargando solicitudes...
    </div>

    <div *ngIf="errorSolicitudes" class="alert alert-danger">
      {{ errorSolicitudes }}
    </div>

    <div
      *ngIf="!cargandoSolicitudes && !errorSolicitudes && solicitudes.length === 0"
      class="alert alert-info"
    >
      A√∫n no has enviado solicitudes de b√∫squeda.
    </div>

    <div
      class="table-responsive"
      *ngIf="!cargandoSolicitudes && solicitudes.length > 0"
    >
      <table class="table table-striped align-middle">
        <thead class="table-light">
          <tr>
            <th>Operaci√≥n / Propiedad</th>
            <th>Ubicaci√≥n</th>
            <th>Presupuesto</th>
            <th>Estado</th>
            <th>Creada</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let s of solicitudes">
            <td>
              {{ s.tipo_operacion }} ¬∑ {{ s.tipo_propiedad }}
              <div class="text-muted small">
                {{
                  (s.mensaje || '').length > 60
                    ? (s.mensaje | slice : 0 : 60) + '...'
                    : s.mensaje
                }}
              </div>
            </td>
            <td>
              {{ s.ciudad }}<br />
              <span class="text-muted small">{{ s.comuna }}</span>
            </td>
            <td>
              <ng-container *ngIf="s.presupuesto_min || s.presupuesto_max; else noPres">
                <div *ngIf="s.presupuesto_min">
                  Min:
                  {{ s.presupuesto_min | currency : 'CLP' : 'symbol-narrow' }}
                </div>
                <div *ngIf="s.presupuesto_max">
                  Max:
                  {{ s.presupuesto_max | currency : 'CLP' : 'symbol-narrow' }}
                </div>
              </ng-container>
              <ng-template #noPres>
                <span class="text-muted small">No especificado</span>
              </ng-template>
            </td>
            <td>
              <span
                class="badge"
                [ngClass]="{
                  'bg-secondary': s.estado === 'nueva',
                  'bg-info': s.estado === 'en_proceso',
                  'bg-success': s.estado === 'respondida',
                  'bg-dark': s.estado === 'cerrada'
                }"
              >
                {{ s.estado | titlecase }}
              </span>
            </td>
            <td>{{ s.created_at | date : 'short' }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>